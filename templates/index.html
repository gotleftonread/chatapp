<!DOCTYPE html>
<html>
<head>
    <title>Mini Discord</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <h1>Mini Discord</h1>
        <input id="usernameInput" placeholder="Enter username...">
        <button id="joinBtn">Join</button>
    </div>

    <!-- MAIN APP -->
    <div id="app" style="display:none;">
        <div id="sidebar">
            <h2>Users</h2>
            <div id="userList"></div>
            <button id="globalChatBtn">Global Chat</button>
        </div>

        <div id="chatContainer" class="panel">
            <div id="messages"></div>
            <input id="messageInput" placeholder="Type a message...">
        </div>

        <div id="dmPanel" class="panel" style="display:none;">
            <div id="dmHeader"></div>
            <div id="dmMessages"></div>
            <input id="dmInput" placeholder="Type a DM...">
        </div>
    </div>

<script>
const socket = io();
let myUsername = null;
let currentDM = null;

// LOGIN
document.getElementById("joinBtn").onclick = () => {
    const name = document.getElementById("usernameInput").value.trim();
    if (!name) return;

    myUsername = name;
    socket.emit("join", { username: myUsername });

    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("app").style.display = "flex";
};

// GLOBAL CHAT SEND
document.getElementById("messageInput").addEventListener("keydown", e => {
    if (e.key === "Enter" && !currentDM) {
        socket.emit("message", {
            sender: myUsername,
            text: e.target.value
        });
        e.target.value = "";
    }
});

// GLOBAL CHAT RECEIVE
socket.on("message", data => {
    const box = document.getElementById("messages");
    const div = document.createElement("div");
    div.textContent = data.sender + ": " + data.text;
    box.appendChild(div);
});

// SYSTEM MESSAGES
socket.on("system_message", msg => {
    const box = document.getElementById("messages");
    const div = document.createElement("div");
    div.classList.add("system");
    div.textContent = msg;
    box.appendChild(div);
});

// USER LIST
socket.on("user_list", list => {
    const ul = document.getElementById("userList");
    ul.innerHTML = "";
    list.forEach(u => {
        const div = document.createElement("div");
        div.classList.add("user");
        div.dataset.username = u;
        div.textContent = u;
        ul.appendChild(div);
    });
});

// RIGHT-CLICK â†’ DM
document.addEventListener("contextmenu", e => {
    if (e.target.classList.contains("user")) {
        e.preventDefault();
        const target = e.target.dataset.username;
        if (target !== myUsername) openDM(target);
    }
});

// OPEN DM PANEL
function openDM(user) {
    currentDM = user;

    const userEl = [...document.querySelectorAll(".user")]
        .find(u => u.dataset.username === user);
    if (userEl) userEl.classList.remove("unread");

    document.getElementById("chatContainer").style.display = "none";
    document.getElementById("dmPanel").style.display = "flex";

    document.getElementById("dmHeader").textContent = "DM with " + user;
    document.getElementById("dmMessages").innerHTML = "";
}

// SEND DM
document.getElementById("dmInput").addEventListener("keydown", e => {
    if (e.key === "Enter" && currentDM) {
        socket.emit("dm", {
            from: myUsername,
            to: currentDM,
            message: e.target.value
        });
        addDMMessage(myUsername, e.target.value);
        e.target.value = "";
    }
});

// RECEIVE DM (with unread indicator)
socket.on("dm", data => {
    const sender = data.from;

    if (currentDM === sender) {
        addDMMessage(sender, data.message);
    } else {
        const userEl = [...document.querySelectorAll(".user")]
            .find(u => u.dataset.username === sender);

        if (userEl) userEl.classList.add("unread");
    }
});

// ADD DM MESSAGE
function addDMMessage(sender, msg) {
    const box = document.getElementById("dmMessages");
    const div = document.createElement("div");
    div.textContent = sender + ": " + msg;
    box.appendChild(div);
}

// BACK TO GLOBAL CHAT
document.getElementById("globalChatBtn").onclick = () => {
    currentDM = null;
    document.getElementById("dmPanel").style.display = "none";
    document.getElementById("chatContainer").style.display = "flex";
};
</script>

</body>
</html>
