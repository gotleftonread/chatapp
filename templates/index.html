<!DOCTYPE html>
<html>
<head>
    <title>Mini Discord</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>
    <div id="sidebar">
        <h2>Users</h2>
        <div id="userList"></div>
        <button id="globalChatBtn">Global Chat</button>
    </div>

    <div id="chatContainer">
        <div id="messages"></div>
        <input id="messageInput" placeholder="Type a message...">
    </div>

    <div id="dmWindow">
        <div id="dmHeader"></div>
        <div id="dmMessages"></div>
        <input id="dmInput" placeholder="Type a DM...">
    </div>

<script>
const socket = io();

// Ask for username
let myUsername = "";
while (!myUsername || myUsername.trim() === "") {
    myUsername = prompt("Enter a username:");
}
myUsername = myUsername.trim();

let currentDM = null;

// Join server
socket.emit("join", { username: myUsername });

// Send global chat messages
document.getElementById("messageInput").addEventListener("keydown", e => {
    if (e.key === "Enter" && !currentDM) {
        socket.emit("message", {
            sender: myUsername,
            text: e.target.value
        });
        e.target.value = "";
    }
});

// Display global messages
socket.on("message", data => {
    const box = document.getElementById("messages");
    const div = document.createElement("div");
    div.textContent = data.sender + ": " + data.text;
    box.appendChild(div);
});

// System messages
socket.on("system_message", msg => {
    const box = document.getElementById("messages");
    const div = document.createElement("div");
    div.classList.add("system");
    div.textContent = msg;
    box.appendChild(div);
});

// Update user list
socket.on("user_list", list => {
    const ul = document.getElementById("userList");
    ul.innerHTML = "";
    list.forEach(u => {
        const div = document.createElement("div");
        div.classList.add("user");
        div.dataset.username = u;
        div.textContent = u;
        ul.appendChild(div);
    });
});

// Right-click â†’ DM
document.addEventListener("contextmenu", e => {
    if (e.target.classList.contains("user")) {
        e.preventDefault();
        const target = e.target.dataset.username;
        if (target !== myUsername) {
            openDMWindow(target);
        }
    }
});

// Open DM window
function openDMWindow(user) {
    currentDM = user;
    document.getElementById("dmHeader").textContent = "DM with " + user;
    document.getElementById("dmWindow").style.display = "flex";
}

// Send DM
document.getElementById("dmInput").addEventListener("keydown", e => {
    if (e.key === "Enter" && currentDM) {
        socket.emit("dm", {
            from: myUsername,
            to: currentDM,
            message: e.target.value
        });
        addDMMessage(myUsername, e.target.value);
        e.target.value = "";
    }
});

// Receive DM
socket.on("dm", data => {
    if (currentDM === data.from) {
        addDMMessage(data.from, data.message);
    }
});

// Add DM message to window
function addDMMessage(sender, msg) {
    const box = document.getElementById("dmMessages");
    const div = document.createElement("div");
    div.textContent = sender + ": " + msg;
    box.appendChild(div);
}

// Global chat button
document.getElementById("globalChatBtn").onclick = () => {
    currentDM = null;
    document.getElementById("dmWindow").style.display = "none";
};
</script>

</body>
</html>
